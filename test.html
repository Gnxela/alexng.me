<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="gallery/jquery-3.0.0.min.js"></script><!-- Totally a good idea -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:100" rel="stylesheet">
		<style>
			body, html, h1, h2 {
				font-weight: 100;
				font-family: Roboto, sans-serif;
				margin: 0px;
				padding: 0px;
				border: 0px;
			}

			html {
				overflow-y: scroll;
			}

			.section {
				text-align: center;
				padding: 20px 0px;
			}

			.section h1 {
				font-size: 48px;
			}

			.column {
				display: table-cell;
				vertical-align: top;
			}

			.image {
				transition: opacity 2s;
				opacity: 0;
			}

			.image, .image img {
				width: 100%;
				display: block;
				user-select: none;
			}

			.fullscreen {
				position: fixed;
				top: 0px;
				left: 0px;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.7);
				user-select: none;
			}

			.fullscreen > .wrapper {
				display: flex;
				align-items: center;
				position: relative;
				top: 50%;
				transform: translate(0, -50%);
				margin: 0px auto;
				width: fit-content;
				height: fit-content;
				max-width: 98%;
				max-height: 98%;
			}

			.fullscreen > .wrapper > img {
				display: inline-block;
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
				flex-shrink: 0;
			}

			.fullscreen > .wrapper > .control {
				display: inline-block;
				background-color: red;
				margin: 10px;
				width: 50px;
				height: 100px;
				flex-shrink: 0;
			}
		</style>
	</head>
	<body>
		<div class="section">
			<h1>Alex Ng</h1>
			<h2>Drawing Gallery</h2>
		</div>
		<div class="gallery"></div>
	</body>
	<script>
		$(document).ready(function() {
			let params = getParams();
			let numColumns = params['cols'] ? params['cols'] : 3;
			let numImages = params['num'] ? params['num'] : 25;

			let columns = []
			let images = [];

			//Adds the columns to the gallery.
			for (let i = 0; i < numColumns; i++) {
				let column = $('<div class="column"></div>');
				column.css("width", (100 / numColumns) + "%");
				$(".gallery").append(column)
				columns.push(column);
			}

			//Loads the images into the columns.
			for (let index = 0; index < numImages; index++) {
				loadImage(index, "http://via.placeholder.com/" + (800 + Math.floor(Math.random() * 500)) + "x" +  (800 + Math.floor(Math.random() * 500)) + "/" + (Math.random()*0xFFFFFF<<0).toString(16) + "?text=." + index + ".");
			}

			function loadImage(position, src) {
				let image = $("<img src=\"" + src + "\"/>")
				let element = image.get(0);
				let interval = setInterval(() => {
					if (element.naturalWidth) {//Rather than the load event. This allows us to add the image to the DOM as soon as we load it's dimentions.
						if (position == 0 || images[position - 1]) {//Insure that the image is only added after it's predecessor.
							clearInterval(interval);
							images[position] = addImage(image, position);
						}
					}
				}, 10);
			}

			function addImage(image, position) {
				let wrapper = image.wrap("<div class=\"image\"></div>").parent().appendTo(getSmallestColumn())

				wrapper.data("position", position);

				wrapper.get(0).offsetHeight;//Forces a CSS update. This forces the transition to always work. Without it most of the time the commands are batched together and don't work (I think?). So I think JS batches the wrapping of the image class and the css update, voiding the transiton. Something about micro and macro event queues.
				wrapper.css("opacity", 1);

				image.get(0).draggable = false;

				wrapper.on('click', (e) => {
					let position = $(e.currentTarget).data("position");
					openImage(position);
				});

				return wrapper;
			}

			function openImage(position) {
				let clone = images[position].clone();
				let controlLeft = $('<div class="control left"></div>');
				let controlRight = $('<div class="control right"></div>');

				function keyControl(e) {
					if (e.which === 39) {//Right arrow
						openImage(Math.min(numImages - 1, position + 1));//Max index is numImages - 1
					} else if (e.which === 37) {//Left arrow
						openImage(Math.max(0, position - 1));
					}
					close();
				}

				$(document).on("keydown", keyControl);

				controlLeft.on('click', () => {
					openImage(Math.max(0, position - 1));
					close();
				});
				controlRight.on('click', () => {
					openImage(Math.min(numImages, position + 1));
					close();
				});

				clone.addClass("fullscreen").appendTo($(".gallery"));
				clone.on('click', (e) => {
					close();
				});

				let image = clone.find("img");
				image.get(0).draggable = true;
				let wrapper = image.wrap("<div class=\"wrapper\"></div>").parent();
				wrapper.prepend(controlLeft);
				wrapper.append(controlRight);
				wrapper.on('click', (e) => {
					e.stopPropagation();
				});

				function close() {
					$(document).off("keydown", keyControl);
					clone.remove();
				}

				return close;
			}

			function getSmallestColumn() {
				let smallest = -1;
				let smallestValue = -1;

				for (let i = 0; i < numColumns; i++) {
					let height = 0;
					let elems = columns[i].children();
					for (let j = 0; j < elems.length; j++) {
						height += $(elems[j]).height();
					}
					if (smallestValue == -1 || height < smallestValue) {
						smallest = i;
						smallestValue = height;
					}
				}
				return columns[smallest];
			}

			function getParams() {//getGETParams?
				let object = {};
				location.search.substr(1).split("&").forEach((param) => {
					let parts = param.split("=");
					object[parts[0]] = decodeURIComponent(parts[1]);
				});
				return object;
			}
		});
	</script>
</html>
